<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interpreter Panel</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      font-family: sans-serif;
      height: 100vh;
    }
    #top-bar {
      display: flex;
      align-items: center;
      padding: 0.5em;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      gap: 8px;
    }
    #top-bar .group {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-right: 10px;
      flex-wrap: wrap;
    }
    #top-bar h1 {
      margin: 0 1em 0 0;
      font-size: 1.25rem;
    }
    #columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr;
      gap: 0;
      flex: 1;
      min-height: 0;
    }
    #votes-section {
      height: 22vh;
      overflow-y: auto;
      border-bottom: 1px solid #ddd;
      padding: 0.5em;
      background: #fafafa;
    }
    #votes-grid {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px 10px;
      align-items: center;
    }
    .song-title {
      font-weight: 600;
    }
    .song-votes {
      text-align: right;
    }
    #now-section {
      padding: 0.5em;
      border-bottom: 1px solid #ddd;
      background: #fff;
    }
    #now-title {
      font-weight: 700;
      margin: 0.3em 0;
    }
    #now-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    #tab-section {
      flex: 1;
      padding: 1em;
      overflow-y: auto;
    }
    #rani-section {
      height: 22vh;
      overflow-y: auto;
      border-top: 1px solid #ddd;
      padding: 0.5em;
      background: #fafafa;
    }
    .btn {
      padding: 6px 10px;
      border: 1px solid #bbb;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn.primary {
      background: #2c7be5;
      border-color: #2c7be5;
      color: #fff;
    }
    .btn.danger {
      background: #e55353;
      border-color: #e55353;
      color: #fff;
    }
    .btn.small { font-size: 0.85rem; padding: 4px 8px; }
    .btn.flat { border: none; background: transparent; }
    .field {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .field input[type="text"] {
      padding: 6px 8px; border: 1px solid #bbb; border-radius: 4px;
    }
    .nowrap { white-space: nowrap; }
    .muted { color: #777; }
    .tag { background:#eee; border-radius:4px; padding:2px 6px; font-size: 0.8rem; }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #ebf5ff;
      color: #0b66c3;
      font-size: 0.8rem;
      border: 1px solid #cde3ff;
    }
    .grid2 {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .grid3 {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
    }
    .note {
      background: #fff7d6;
      border: 1px solid #e5d27d;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    /* TAB STYLES */
    #tab-title { margin: 0; font-size: 1.2rem; }
    #tab-meta { margin: 0 0 6px 0; color:#666; font-size:0.9rem; }
    #tab-content {
      font-size: 1rem;         /* base default */
      line-height: 1.15;       /* compacto para que quepan líneas */
      font-family: Consolas, "Courier New", Menlo, Monaco, monospace;
      white-space: pre-wrap;
    }

    /* Autoscroll controls */
    #autoscroll{
      position:fixed;
      top:10px; right:10px;
      z-index: 9000;
      display:flex; flex-direction:column; gap:6px;
    }
    #autoscroll button{
      padding:10px 12px;
      font-size:16px;
      background:#333; color:white;
      border:none; border-radius:50%;
      width:44px; height:44px;
      cursor:pointer;
      opacity:0.85;
    }
    #autoscroll button:hover{ opacity:1; }
    #autoscroll .active{
      background: mediumseagreen;
    }
    .as-speed{ background: #555; }
    .as-toggle{ background: #1c1c1c; }
    .as-reset{ background: #e55353; }

    /* Sticky toolbar for TAB */
    #tab-toolbar{
      position: sticky;
      top: 0; z-index: 2;
      background: white; border-bottom:1px solid #ddd;
      padding: 6px; display:flex; gap:6px; align-items:center; justify-content: space-between;
    }
    #tab-toolbar .left, #tab-toolbar .right{
      display:flex; gap:6px; align-items:center;
    }
    #tab-toolbar input[type="range"]{ width: 160px; }
    #tab-toolbar .pill{
      padding:4px 8px; border:1px solid #ddd; border-radius:999px; font-size:0.85rem; background:#fafafa;
    }
    #tab-toolbar .pill b{ margin: 0 4px; }

    /* RANI list */
    #rani-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
    #rani-list li{
      display:grid; grid-template-columns: 1fr auto auto; gap:6px; align-items:center;
      background:#fff; padding:6px 8px; border:1px solid #eee; border-radius:6px;
    }
    #rani-list .title{ font-weight:600; }
    #rani-list .votes{ font-variant-numeric: tabular-nums; }
    #rani-list button{ padding:4px 8px; font-size:0.85rem; }
    #rani-list .play{ background: mediumseagreen; color:white; border:none; border-radius:5px; cursor:pointer; }
    #rani-list .del{ background: #e55353; color:white; border:none; border-radius:5px; cursor:pointer; }

    /* Quick actions */
    #qa{ display:flex; gap:8px; align-items:center; }
    #qa button{ padding:6px 10px; }
    #drain{ background: darkslategray; color:white; border:none; border-radius:5px; cursor:pointer; }
    #reset{ background: #e55353; color:white; border:none; border-radius:5px; cursor:pointer; }
    #playbtn{ background: mediumorchid; color:white; border:none; border-radius:5px; cursor:pointer; }
    #tab-section {
      flex: 1;
      padding: 1em;
      overflow-y: auto;
    }
    #rani-section {
      height: 22vh;
      overflow-y: auto;
  
    }
  </style>
</head>
<body>

  <div id="top-bar">
    <h1>Interpreter</h1>

    <div id="qa" class="group">
      <span class="muted">Quick actions:</span>
      <button id="drain" class="btn small danger">Reset votes</button>
      <button id="playbtn" class="btn small">Set now playing</button>
      <button id="reset" class="btn small danger">Restart session</button>
    </div>

    <div class="group">
      <span class="tag">RANi</span>
      <span class="muted">Click → select, click again → confirm</span>
    </div>
  </div>

  <div id="columns">
    <!-- Votes -->
    <section id="votes-section">
      <div class="grid3">
        <div class="nowrap muted">Device</div>
        <div class="nowrap muted">Song</div>
        <div class="nowrap muted">Votes</div>
      </div>
      <div id="votes-grid"></div>
    </section>

    <!-- Now playing -->
    <section id="now-section">
      <div class="grid2">
        <div>
          <div class="muted">Now playing</div>
          <div id="now-title">(none)</div>
        </div>
        <div class="nowrap">
          <span id="now-id" class="badge">—</span>
        </div>
      </div>
      <div id="now-controls">
        <div class="field">
          <label for="np-id" class="muted">Song ID</label>
          <input id="np-id" type="text" placeholder="song_id">
          <button id="np-load" class="btn">Load TAB</button>
        </div>
        <div class="field">
          <label for="np-title" class="muted">Title</label>
          <input id="np-title" type="text" placeholder="Song title">
        </div>
        <button id="np-set" class="btn primary">Set now playing</button>
      </div>
    </section>

    <!-- TAB -->
    <section id="tab-section">
      <div id="tab-toolbar">
        <div class="left">
          <span class="pill">Text size <b id="fontSize">1.00</b>×</span>
          <input id="fontRange" type="range" min="0.6" max="2.0" step="0.05" value="1.00">
          <span class="pill">Line height <b id="lineH">1.15</b></span>
          <input id="lineRange" type="range" min="1.0" max="2.0" step="0.05" value="1.15">
        </div>
        <div class="right">
          <span class="muted">Autoscroll</span>
          <button id="as-play" class="btn">Play</button>
          <button id="as-stop" class="btn">Stop</button>
          <button id="as-reset" class="btn">Reset</button>
          <span class="pill">Speed <b id="asSpeed">1.0</b>x</span>
          <input id="speedRange" type="range" min="0.5" max="3" step="0.1" value="1.0">
        </div>
      </div>
      <h2 id="tab-title">—</h2>
      <div id="tab-meta"></div>
      <pre id="tab-content">No TAB loaded.</pre>
    </section>

    <!-- RANi -->
    <section id="rani-section">
      <ul id="rani-list"></ul>
    </section>
  </div>

  <script>
    let catalog = [];
    let songVotes = {};
    let states = {};
    let byDevice = {};

    function renderVotedSongs(devVotes) {
      byDevice = devVotes || {};
      const grid = document.getElementById("votes-grid");
      grid.innerHTML = "";

      Object.keys(byDevice).sort().forEach(device => {
        const info = byDevice[device] || {};
        const row = document.createElement("div");
        row.className = "grid3";
        const title = (window.songCatalog?.[info.id]?.title) || info.id || "—";
        const votes = (info.votes ?? 0);

        const c1 = document.createElement("div");
        c1.textContent = device;
        const c2 = document.createElement("div");
        c2.innerHTML = `<span class="song-title">${title}</span> <span class="muted">(${info.id||"—"})</span>`;
        const c3 = document.createElement("div");
        c3.className = "song-votes";
        c3.textContent = votes;

        row.append(c1, c2, c3);
        grid.append(row);
      });
    }

    function setNowPlaying(id, title) {
      document.getElementById("now-id").textContent = id || "—";
      document.getElementById("now-title").textContent = title || "—";
    }

    function loadTab(id) {
      if (!id) return;
      fetch(`/songs/tabs/TAB${id}.txt`)
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(txt => {
          document.getElementById("tab-title").textContent = window.songCatalog?.[id]?.title || id;
          document.getElementById("tab-meta").textContent = `TAB: TAB${id}.txt`;
          document.getElementById("tab-content").textContent = txt;
        })
        .catch(() => {
          document.getElementById("tab-title").textContent = id;
          document.getElementById("tab-meta").textContent = `TAB: not found`;
          document.getElementById("tab-content").textContent = "No TAB found.";
        });
    }

    function addSongEntry(id, title, votes) {
      const li = document.createElement("li");
      li.dataset.id = id;

      const t = document.createElement("div");
      t.className = "title";
      t.textContent = title || id;

      const v = document.createElement("div");
      v.className = "votes";
      v.textContent = votes ?? 0;

      const b = document.createElement("button");
      b.className = "play";
      b.textContent = "Play";
      b.addEventListener("click", async () => {
        try {
          const res = await fetch("/votes/now_playing", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ id })
          });
          const j = await res.json();
          if (j?.ok) {
            setNowPlaying(id, title || id);
            loadTab(id);
          }
        } catch(e){}
      });

      li.append(t, v, b);
      document.getElementById("rani-list").append(li);
    }

    async function init() {
      const catRes = await fetch('/catalog/catalog.json');
      catalog = await catRes.json();
      window.songCatalog = {};
      catalog.forEach(song => {
        window.songCatalog[song.id] = { title: song.title, state: null };
      });

      window.socket = io({ transports: ['websocket'], upgrade: false });
      window.socket.on("connect", () => console.log("WebSocket connected"));

      window.socket.on("update", data => {
        renderVotedSongs(data.byDevice || {});

        const nowPlayingEntry = Object.entries(window.songCatalog || {}).find(
          ([, data]) => data.state === "now_playing"
        );
        if (nowPlayingEntry) {
          const [id, song] = nowPlayingEntry;
          setNowPlaying(id, song.title || id);
          loadTab(id);
        }
      });

      const voteRes = await fetch('/votes/counts.json');
      const voteData = await voteRes.json();
      songVotes = voteData.counts || {};

      const statesRes = await fetch('/song_states.json');
      const statesData = await statesRes.json();
      states = statesData || {};

      const byDevRes = await fetch('/votes/by_device.json');
      const byDev = await byDevRes.json();
      renderVotedSongs(byDev || {});

      document.getElementById("rani-list").innerHTML = "";
      catalog.forEach(song => addSongEntry(song.id, song.title, songVotes[song.id]));

      // If there's a now playing
      if (states?.now_playing) {
        const id = states.now_playing;
        setNowPlaying(id, window.songCatalog?.[id]?.title || id);
        loadTab(id);
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>

  <!-- Proposals: toolbar -->
  <script>
  (function(){
    const list = document.getElementById('rani-list');
    const input = document.createElement('input');
    input.placeholder = 'Propose a song id...';
    input.id = 'proposal-input';
    input.style.padding = '6px 8px';
    input.style.border = '1px solid #bbb';
    input.style.borderRadius = '4px';
    input.style.margin = '0 8px 0 0';
    const btnAdd = document.createElement('button');
    btnAdd.textContent = 'Propose';
    btnAdd.className = 'btn';

    const toolbar = document.createElement('div');
    toolbar.style.margin = '6px 0';
    toolbar.append(input, btnAdd);
    const parent = document.getElementById('rani-section');
    parent.insertBefore(toolbar, parent.firstChild);

    btnAdd.addEventListener('click', async () => {
      const slug = (input.value||'').trim();
      if(!slug) return;
      try {
        const r = await fetch('/proposals', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slug })
        });
        const j = await r.json();
        if(j.ok){
          input.value='';
        }
      }catch(e){}
    });

    async function refresh(){
      try {
        const r = await fetch('/proposals');
        const j = await r.json();
        list.innerHTML = '';
        (j.proposals || []).forEach(p => list.appendChild(makeRow(p)));
      } catch(e) {}
    }

    // Inicial
    refresh();

    function makeRow(p){
      const li = document.createElement('li');
      li.dataset.slug = p.slug;

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = p.title || p.slug;

      const votes = document.createElement('div');
      votes.className = 'votes';
      votes.textContent = p.votes ?? 0;

      const btnCopy = document.createElement('button');
      btnCopy.textContent = 'Use';
      btnCopy.className = 'play';
      btnCopy.addEventListener('click', ()=>{
        document.getElementById('np-id').value = p.slug;
        document.getElementById('np-title').value = p.title || p.slug;
      });

      const btnSearch = document.createElement('button');
      btnSearch.textContent = 'Search';
      btnSearch.className = 'btn';
      btnSearch.addEventListener('click', ()=>{
        const q = encodeURIComponent(p.title || p.slug);
        window.open(`https://www.google.com/search?q=${q}`, '_blank');
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Delete';
      btnDel.className = 'del';
      btnDel.addEventListener('click', async ()=>{
        try{
          await fetch(`/proposals/${encodeURIComponent(p.slug)}`, { method:'DELETE' });
        }catch(e){}
      });

      li.append(title, btnCopy, btnSearch, btnDel);
      return li;
    }

    // En tiempo real
    if (window.socket) {
      window.socket.on('proposal_added', ()=> refresh());
      window.socket.on('proposal_removed', ({slug})=>{
        const node = list.querySelector(`li[data-slug="${slug}"]`);
        if (node) node.remove();
      });
    }
  })();
  </script>

  <!-- Proposals panel -->
  <section id="proposals-panel" style="margin-top:16px; border-top:1px solid #ddd; padding-top:12px;">
    <h3 style="margin:0 0 8px 0;">Proposals</h3>
    <ul id="proposals-list" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px;"></ul>
  </section>

  <script>
  (function(){
    const list = document.getElementById('proposals-list');

    function makeRow(p){
      const li = document.createElement('li');
      li.dataset.slug = p.slug;

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = p.title || p.slug;

      const votes = document.createElement('div');
      votes.className = 'votes';
      votes.textContent = p.votes ?? 0;

      const btnCopy = document.createElement('button');
      btnCopy.textContent = 'Use';
      btnCopy.className = 'play';
      btnCopy.addEventListener('click', ()=>{
        document.getElementById('np-id').value = p.slug;
        document.getElementById('np-title').value = p.title || p.slug;
      });

      const btnSearch = document.createElement('button');
      btnSearch.textContent = 'Search';
      btnSearch.className = 'btn';
      btnSearch.addEventListener('click', ()=>{
        const q = encodeURIComponent(p.title || p.slug);
        window.open(`https://www.google.com/search?q=${q}`, '_blank');
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Delete';
      btnDel.className = 'del';
      btnDel.addEventListener('click', async ()=>{
        try{
          await fetch(`/proposals/${encodeURIComponent(p.slug)}`, { method:'DELETE' });
        }catch(e){}
      });

      li.append(title, btnCopy, btnSearch, btnDel);
      return li;
    }

    async function refresh(){
      try {
        const r = await fetch('/proposals');
        const j = await r.json();
        list.innerHTML = '';
        (j.proposals || []).forEach(p => list.appendChild(makeRow(p)));
      } catch(e) {}
    }

    // Inicial
    refresh();

    // En tiempo real
    if (window.socket) {
      window.socket.on('proposal_added', ()=> refresh());
      window.socket.on('proposal_removed', ({slug})=>{
        const node = list.querySelector(`li[data-slug="${slug}"]`);
        if (node) node.remove();
      });
    }
  })();
  </script>

  <script>
  (function(){
    const container = document.getElementById('tab-section');
    if(!container) return;

    const btnPlay   = document.getElementById('as-play');
    const speedBtns = Array.from(document.querySelectorAll('.as-speed'));

    let rafId = null;
    let isPlaying = false;
    let pixelsPerSecond = 30; // base

    function updateUI(){
      document.getElementById('asSpeed').textContent = (pixelsPerSecond/30).toFixed(1);
    }

    function step(){
      if(!isPlaying) return;
      container.scrollTop += (pixelsPerSecond/60);
      rafId = requestAnimationFrame(step);
    }

    btnPlay.addEventListener('click', ()=>{
      isPlaying = !isPlaying;
      if(isPlaying) {
        btnPlay.textContent = 'Stop';
        btnPlay.classList.add('active');
        step();
      } else {
        btnPlay.textContent = 'Play';
        btnPlay.classList.remove('active');
        cancelAnimationFrame(rafId);
      }
    });

    document.getElementById('as-stop').addEventListener('click', ()=>{
      isPlaying = false;
      btnPlay.textContent = 'Play';
      btnPlay.classList.remove('active');
      cancelAnimationFrame(rafId);
    });

    document.getElementById('as-reset').addEventListener('click', ()=>{
      container.scrollTop = 0;
      isPlaying = false;
      btnPlay.textContent = 'Play';
      btnPlay.classList.remove('active');
      cancelAnimationFrame(rafId);
    });

    const fontRange = document.getElementById('fontRange');
    const lineRange = document.getElementById('lineRange');

    const tabContent = document.getElementById('tab-content');
    const fontSizeEl = document.getElementById('fontSize');
    const lineHEl    = document.getElementById('lineH');

    function applyStyles(){
      const f = parseFloat(fontRange.value);
      const lh = parseFloat(lineRange.value);
      tabContent.style.fontSize = f + 'rem';
      tabContent.style.lineHeight = lh;
      fontSizeEl.textContent = f.toFixed(2);
      lineHEl.textContent = lh.toFixed(2);
    }

    fontRange.addEventListener('input', applyStyles);
    lineRange.addEventListener('input', applyStyles);
    applyStyles();
  })();
  </script>

  <script>
    // Quick actions handlers
    document.getElementById("drain").addEventListener("click", async () => {
      if (!confirm("Reset all votes?")) return;
      try {
        await fetch("/votes/reset", { method: "POST" });
      } catch(e){}
    });

    document.getElementById("reset").addEventListener("click", async () => {
      if (!confirm("Restart session (clear states and votes)?")) return;
      try {
        await fetch("/session/restart", { method: "POST" });
      } catch(e){}
    });

    document.getElementById("playbtn").addEventListener("click", async () => {
      const id = document.getElementById("np-id").value.trim();
      const title = document.getElementById("np-title").value.trim();
      if (!id) return;

      try {
        const res = await fetch("/votes/now_playing", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ id })
        });
        const j = await res.json();
        if (j?.ok) {
          setNowPlaying(id, title || window.songCatalog?.[id]?.title || id);
          loadTab(id);
        }
      } catch(e){}
    });

    document.getElementById("np-load").addEventListener("click", () => {
      const id = document.getElementById("np-id").value.trim();
      if (!id) return;
      setNowPlaying(id, window.songCatalog?.[id]?.title || id);
      loadTab(id);
    });
  </script>

</body>
</html>
