<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Control</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 2em; max-width: 860px; background: #f5f7fa; color: #333; }
    h1, h2 { color: #2c3e50; }
    input, textarea, button, select { width: 100%; margin-bottom: 0.75em; padding: 0.6em; font-size: 1em; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    button { background: #3498db; color: white; border: none; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #2980b9; }
    label { font-weight: 600; margin-top: 1em; display: block; }
    #form-container { background: white; border: 1px solid #ddd; padding: 2em; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .side-by-side { display: flex; gap: 1em; }
    .side-by-side>div { flex: 1; }
    #song-list li { display: flex; align-items: center; margin-bottom: 4px; gap: 0.5em; }
    #song-list input[type="checkbox"] { flex: 0 0 40px; margin-right: 0.5em; }
    #song-list span { flex: 1; white-space: normal; overflow: visible; text-overflow: clip; }
  </style>
</head>
<body>

  <h1>Panel de Control</h1>

  <div id="form-container">
    <label for="id">ID *</label>
    <input type="text" id="id" required>

    <label for="name">T√≠tulo</label>
    <input type="text" id="name">

    <label for="artist">Artista</label>
    <input type="text" id="artist" list="artist-list">

    <label for="year">A√±o</label>
    <input type="number" id="year" list="year-list" min="1000" max="9999">

    <label for="language">Idioma</label>
    <input type="text" id="language" list="language-list">

    <label for="genre">G√©nero</label>
    <input type="text" id="genre" list="genre-list">

    <label for="duration">Duraci√≥n (segundos)</label>
    <input type="number" id="duration" min="1">

    <label for="mood">Estado de √°nimo</label>
    <input type="text" id="mood" list="mood-list">

    <label for="key">Tonalidad</label>
    <input type="text" id="key" list="key-list">

    <label for="tempo">Tempo (BPM)</label>
    <input type="number" id="tempo" min="1">

    <div class="side-by-side">
      <div>
        <label for="lyrics">Letra</label>
        <textarea id="lyrics" rows="12"></textarea>
      </div>
      <div>
        <label for="tab">Tablatura</label>
        <textarea id="tab" rows="12"></textarea>
      </div>
    </div>

    <button type="button" onclick="submitForm()">A√±adir canci√≥n</button>

    <div class="side-by-side">
      <button type="button" onclick="editCatalog()">Editar datos</button>
      <button type="button" onclick="downloadCatalog()">Descargar cat√°logo</button>
    </div>

    <div class="side-by-side">
      <input type="file" id="catalog-file" name="catalog" accept=".csv" required>
      <button type="button" onclick="uploadCatalog()">Subir cat√°logo</button>
    </div>

    <button type="button" onclick="refreshCatalog()">Actualizar cat√°logo</button>

    <div class="side-by-side">
      <input type="file" id="logo-file" name="logo" accept=".png,.jpg,.jpeg" required>
      <button type="button" onclick="uploadLogo()">Actualizar logo</button>
    </div>

    <button type="button" onclick="goBack()">a Pantalla de Int√©rprete</button>

    <h2>Borrar / Mostrar canciones</h2>
    <div>
      <button type="button" onclick="loadSongList()">Cargar lista de canciones</button>
      <select id="sort-songs" onchange="sortSongs()">
        <option value="title">Ordenar por t√≠tulo</option>
        <option value="artist">Ordenar por artista</option>
      </select>
      <button type="button" onclick="updateEnabledSongs()">Actualizar Mostrar</button>
      <button type="button" onclick="deleteSelectedSongs()">Borrar seleccionadas</button>
    </div>

    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 1em; margin-top: 1em;">
      <ul id="song-list" style="list-style: none; padding: 0;"></ul>
    </div>

    <button type="button" onclick="loadMissingArtists()">üîÑ Actualizar lista de artistas sin foto</button>

    <h2>Artistas sin foto</h2>
    <div id="missing-artists-section" style="border: 1px solid #ccc; padding: 1em; margin-top: 1em;"></div>
  </div>

  <script>
    // ===== A√±adir canci√≥n =====
    async function submitForm() {
      const data = {
        id: document.getElementById("id").value.trim(),
        name: document.getElementById("name").value.trim(),
        artist: document.getElementById("artist").value.trim(),
        year: document.getElementById("year").value.trim(),
        language: document.getElementById("language").value.trim(),
        genre: document.getElementById("genre").value.trim(),
        duration: document.getElementById("duration").value.trim(),
        mood: document.getElementById("mood").value.trim(),
        key: document.getElementById("key").value.trim(),
        tempo: document.getElementById("tempo").value.trim(),
        lyrics: document.getElementById("lyrics").value,
        tab: document.getElementById("tab").value,
      };

      if (!data.id) {
        alert("El campo ID es obligatorio.");
        return;
      }

      try {
        const res = await fetch("/add-song", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
          await refreshCatalog();   // regenerar catalog.json
          // Limpieza r√°pida de campos principales
          ["id","name","artist","year","language","genre","duration","mood","key","tempo","lyrics","tab"].forEach(id => document.getElementById(id).value = "");
        }
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al a√±adir canci√≥n");
      }
    }

    // ===== Cat√°logo (upload/refresh/download/edit) =====
    async function uploadCatalog() {
      const fileInput = document.getElementById("catalog-file");
      if (!fileInput.files || !fileInput.files[0]) {
        alert("Selecciona un CSV primero");
        return;
      }
      try {
        const fd = new FormData();
        fd.append("catalog", fileInput.files[0]);
        const res = await fetch("/upload-catalog", { method: "POST", body: fd });
        const text = await res.text();
        alert(text);
        if (res.ok) await refreshCatalog();
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al subir cat√°logo");
      }
    }

    async function refreshCatalog() {
      try {
        const res = await fetch("/refresh-catalog", { method: "POST" });
        const text = await res.text();
        alert(text);
        // bust cache y recargar UI dependiente
        await fetch("/catalog/catalog.json?t=" + Date.now());
        await loadSongList(); // refresca la lista por si cambi√≥
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al actualizar cat√°logo");
      }
    }

    function downloadCatalog() {
      window.location.href = "/download-catalog";
    }

    function editCatalog() {
      window.open("/edit-catalog", "_blank");
    }

    async function uploadLogo() {
      const fileInput = document.getElementById("logo-file");
      if (!fileInput.files.length) {
        alert("Por favor selecciona un archivo de imagen.");
        return;
      }
      try {
        const fd = new FormData();
        fd.append("logo", fileInput.files[0]);
        const res = await fetch("/upload-logo", { method: "POST", body: fd });
        const msg = await res.text();
        alert(msg);
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al subir logo");
      }
    }

    function goBack() {
      window.location.href = "/inter.html";
    }

    // ===== Gesti√≥n de canciones (listar / ordenar / borrar / enabled) =====
    let fullSongList = [];

    async function loadSongList() {
      try {
        const res = await fetch("/get-song-status");
        const data = await res.json();
        fullSongList = Array.isArray(data) ? data : [];
        renderSongs(fullSongList);
      } catch (e) {
        console.error(e);
        alert("‚ùå Error cargando lista de canciones");
      }
    }

    function renderSongs(songs) {
      const ul = document.getElementById("song-list");
      ul.innerHTML = "";

      const header = document.createElement("li");
      header.innerHTML = `
        <span style="flex: 0 0 40px;">Borrar</span>
        <span style="flex: 0 0 60px;">Mostrar</span>
        <span style="flex: 1; font-weight: bold;">Canci√≥n</span>`;
      ul.appendChild(header);

      songs.forEach(song => {
        const li = document.createElement("li");

        const cbDelete = document.createElement("input");
        cbDelete.type = "checkbox";
        cbDelete.className = "delete-checkbox";
        cbDelete.value = song.id;

        const cbEnabled = document.createElement("input");
        cbEnabled.type = "checkbox";
        cbEnabled.className = "enabled-checkbox";
        cbEnabled.value = song.id;
        cbEnabled.checked = (song.enabled || "Y") === "Y";

        const label = document.createElement("span");
        label.textContent = `${song.title} ‚Äî ${song.artist}`;

        li.appendChild(cbDelete);
        li.appendChild(cbEnabled);
        li.appendChild(label);
        ul.appendChild(li);
      });
    }

    function sortSongs() {
      const type = document.getElementById("sort-songs").value;
      const sorted = [...fullSongList].sort((a, b) => (a[type] || "").localeCompare(b[type] || ""));
      renderSongs(sorted);
    }

    async function deleteSelectedSongs() {
      const boxes = document.querySelectorAll("#song-list .delete-checkbox:checked"); // ‚úÖ solo los de borrar
      if (!boxes.length) {
        alert("No has seleccionado ninguna canci√≥n para borrar.");
        return;
      }
      if (!confirm("¬øSeguro que quieres borrar las canciones seleccionadas?")) return;

      const ids = Array.from(boxes).map(cb => cb.value);
      try {
        const res = await fetch("/delete-songs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        });
        const msg = await res.text();
        alert(msg);
        await loadSongList();
        await refreshCatalog();
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al borrar canciones");
      }
    }

    async function updateEnabledSongs() {
      const checkboxes = document.querySelectorAll(".enabled-checkbox");
      const updates = {};
      checkboxes.forEach(cb => { updates[cb.value] = cb.checked; });

      try {
        const res = await fetch("/update-enabled", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ enabled: updates })
        });
        const msg = await res.text();
        alert(msg);
        await refreshCatalog();
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al actualizar estado");
      }
    }

    // ===== Fotos de artistas faltantes =====
    async function loadMissingArtists() {
      try {
        const res = await fetch("/missing-artist-photos");
        const data = await res.json();
        const section = document.getElementById("missing-artists-section");
        section.innerHTML = "";
        (data || []).forEach(artist => {
          const button = document.createElement("div");
          button.textContent = artist;
          button.setAttribute("data-artist", artist);
          button.setAttribute("tabindex", "0");
          button.style.cursor = "pointer";
          button.style.border = "1px solid #aaa";
          button.style.padding = "0.5em";
          button.style.margin = "0.25em 0";
          button.style.background = "#f9f9f9";
          button.style.borderRadius = "5px";
          button.style.transition = "background 0.3s";

          button.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".jpg,.jpeg,.png,.bmp";
            input.onchange = () => uploadArtistPhoto(artist, input.files[0], button);
            input.click();
          });
          button.addEventListener("dragover", e => { e.preventDefault(); button.style.background = "#cce5cc"; });
          button.addEventListener("dragleave", () => { button.style.background = "#f9f9f9"; });
          button.addEventListener("drop", e => {
            e.preventDefault();
            button.style.background = "#f9f9f9";
            const file = e.dataTransfer.files[0];
            if (file) uploadArtistPhoto(artist, file, button);
          });
          section.appendChild(button);
        });
      } catch (e) {
        console.error(e);
        alert("‚ùå Error cargando artistas sin foto");
      }
    }

    async function uploadArtistPhoto(artist, file, button) {
      const fd = new FormData();
      fd.append("photo", file);
      try {
        const res = await fetch(`/upload-artist-photo/${encodeURIComponent(artist)}`, { method: "POST", body: fd });
        const msg = await res.text();
        if (res.ok) {
          button.style.background = "#d4edda"; // verde √©xito
          button.textContent = `‚úî ${artist}`;
          setTimeout(() => button.remove(), 1000);
        } else {
          button.style.background = "#f8d7da"; // rojo error
          alert(`Error: ${msg}`);
        }
      } catch (e) {
        console.error(e);
        alert("‚ùå Error subiendo imagen");
      }
    }

    // ===== Campos h√≠bridos (datalists) =====
    async function loadHybridFields() {
      try {
        const res = await fetch("/catalog/fields.json");
        const data = await res.json();
        const campos = ["artist", "year", "language", "genre", "mood", "key"];
        for (const campo of campos) {
          const datalist = document.getElementById(`${campo}-list`);
          if (!datalist) continue;
          datalist.innerHTML = "";
          (data[campo] || []).forEach(valor => {
            const opt = document.createElement("option");
            opt.value = valor;
            datalist.appendChild(opt);
          });
        }
      } catch (e) {
        console.error("Error cargando campos h√≠bridos:", e);
      }
    }

    // Carga inicial
    window.addEventListener("DOMContentLoaded", () => {
      loadMissingArtists();
      loadHybridFields();
      loadSongList();
    });
  </script>

  <datalist id="artist-list"></datalist>
  <datalist id="year-list"></datalist>
  <datalist id="language-list"></datalist>
  <datalist id="genre-list"></datalist>
  <datalist id="mood-list"></datalist>
  <datalist id="key-list"></datalist>
</body>
</html>
