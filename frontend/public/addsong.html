<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Control</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 2em; max-width: 860px; background: #f5f7fa; color: #333; }
    h1, h2 { color: #2c3e50; }
    input, textarea, button, select { width: 100%; margin-bottom: 0.6em; padding: 0.6em; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    button { background: #3498db; color: white; border: none; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #2980b9; }
    label { font-weight: 600; margin-top: 1em; display: block; }
    #form-container { background: white; border: 1px solid #ddd; padding: 1.2em; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .side-by-side { display: flex; gap: 1em; }
    .side-by-side>div { flex: 1; }
    #song-list li { display: flex; align-items: center; margin-bottom: 4px; gap: 0.5em; }
    #song-list input[type="checkbox"] { flex: 0 0 40px; margin-right: 0.5em; }
    #song-list span { flex: 1; white-space: normal; overflow: visible; text-overflow: clip; }
  </style>
  <style>
    /* Admin lock overlay */
    #admin-lock{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:99999; }
    #admin-lock .panel{ background:#fff; padding:18px 16px; border-radius:12px; width:min(420px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.25); }
    #admin-lock h2{ margin:0 0 10px; font-size:1.1rem; }
    #admin-lock input{ width:100%; padding:10px; font-size:1rem; box-sizing:border-box; }
    #admin-lock button{ margin-top:10px; padding:10px 12px; font-size:1rem; }
  </style>
</head>
<body>

<div id="admin-lock" aria-modal="true" role="dialog">
  <div class="panel">
    <h2>Admin access</h2>
    <p style="margin:0 0 8px; color:#444;">Enter password to use this panel.</p>
    <input id="admin-pass" type="password" placeholder="Password" autocomplete="current-password"/>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="admin-login">Unlock</button>
      <button id="admin-cancel" style="background:#eee;">Cancel</button>
    </div>
    <div id="admin-msg" style="margin-top:8px; color:#b00020; min-height:1em;"></div>
  </div>
</div>

  <h1>Panel de Control</h1>

  <div id="form-container">
    <label for="id">ID *</label>
    <input type="text" id="id" required>

    <label for="name">T√≠tulo</label>
    <input type="text" id="name">

    <label for="artist">Artista</label>
    <input type="text" id="artist" list="artist-list">

    <label for="year">A√±o</label>
    <input type="number" id="year" list="year-list" min="1000" max="9999">

    <label for="language">Idioma</label>
    <input type="text" id="language" list="language-list">

    <label for="genre">G√©nero</label>
    <input type="text" id="genre" list="genre-list">

    <label for="duration">Duraci√≥n (segundos)</label>
    <input type="number" id="duration" min="1">

    <label for="mood">Estado de √°nimo</label>
    <input type="text" id="mood" list="mood-list">

    <label for="key">Tonalidad</label>
    <input type="text" id="key" list="key-list">

    <label for="tempo">Tempo (BPM)</label>
    <input type="number" id="tempo" min="1">

    <label for="lyrics">Letra</label>
    <textarea id="lyrics" rows="10"></textarea>

    <label for="tab">Tablatura</label>
    <textarea id="tab" rows="10"></textarea>

    <label for="enabled">Mostrar (Y/N)</label>
    <input type="text" id="enabled" value="Y">

    <div class="side-by-side">
      <div>
        <label for="image">Imagen (opcional)</label>
        <input type="file" id="image" accept="image/*">
      </div>
      <div>
        <label for="flag">Bandera (opcional)</label>
        <input type="file" id="flag" accept="image/*">
      </div>
    </div>

    <button type="button" onclick="submitForm()">A√±adir canci√≥n</button>

    <!-- Paste & Add (fast) -->
    <section id="paste-add" style="border:1px solid #ccc; border-radius:10px; padding:12px; margin:16px 0;">
      <h3 style="margin-top:0;">Paste & Add (fast)</h3>
      <p>Pega aqu√≠ tu tablatura; detectaremos t√≠tulo, artista, a√±o‚Ä¶ y generaremos TAB y letras.</p>
      <textarea id="paste-input" rows="12" style="width:100%; font-family: monospace;"></textarea>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0;">
        <button id="btn-parse" type="button">Parse</button>
        <button id="btn-fetch" type="button">Fetch metadata</button>
        <button id="btn-create" type="button" disabled>Create files & add to catalog</button>
      </div>

      <div id="parse-result" style="display:none;">
        <h4>Detected</h4>
        <div style="display:grid; grid-template-columns: 140px 1fr; gap:6px; align-items:center;">
          <label>ID</label>         <input id="det-id">
          <label>Title</label>      <input id="det-title">
          <label>Artist</label>     <input id="det-artist">
          <label>Year</label>       <input id="det-year">
          <label>Language</label>   <input id="det-lang" value="English">
          <label>Genre</label>      <input id="det-genre" placeholder="(optional)">
        </div>
      <div style="margin-top:10px;">
        <strong>Lyrics guess:</strong>
        <textarea id="det-lyrics" rows="10" style="width:100%; font-family: monospace; padding:8px; border:1px solid #eee; border-radius:6px;"></textarea>
      </div>
      </div>

      <details style="margin-top:10px;">
        <summary>¬øC√≥mo formateo el texto pegado?</summary>
        <ul>
          <li>Primera l√≠nea: <code>Artist ‚Äî Title</code> o <code>Title ‚Äî Artist (Year)</code></li>
          <li>Usa espacios en blanco para separar versos y estrofas</li>
          <li>Si hay acordes por encima, los reconoceremos</li>
        </ul>
      </details>
    </section>

    <hr>

    <h2>Cat√°logo (CSV)</h2>
    <div class="side-by-side">
      <div>
        <label for="catalog-file">Subir CSV del cat√°logo</label>
        <input type="file" id="catalog-file" accept=".csv">
        <button type="button" onclick="uploadCatalog()">Subir cat√°logo</button>
      </div>
      <div>
        <button type="button" onclick="downloadCatalog()">Descargar cat√°logo</button>
      </div>
    </div>

    <button type="button" onclick="refreshCatalog()">Actualizar cat√°logo</button>

    <h2>Actualizar un campo (uno solo)</h2>
    <div class="side-by-side">
      <div>
        <label for="fix-id">ID</label>
        <input id="fix-id" type="text">
      </div>
      <div>
        <label for="fix-field">Campo</label>
        <select id="fix-field">
          <option value="title">title</option>
          <option value="artist">artist</option>
          <option value="year">year</option>
          <option value="language">language</option>
          <option value="genre">genre</option>
          <option value="duration">duration</option>
          <option value="mood">mood</option>
          <option value="key">key</option>
          <option value="tempo">tempo</option>
          <option value="enabled">enabled</option>
        </select>
      </div>
    </div>
    <label for="fix-value">Nuevo valor</label>
    <input id="fix-value" type="text" placeholder="nuevo valor... (Y/N para enabled)">
    <button type="button" onclick="updateOneField()">Actualizar campo</button>

    <button type="button" onclick="goBack()">a Pantalla de Int√©rprete</button>

    <h2>Borrar / Mostrar canciones</h2>
    <div>
      <button type="button" onclick="loadSongList()">Cargar lista de canciones</button>
      <select id="sort-songs" onchange="sortSongs()">
        <option value="title">Ordenar por t√≠tulo</option>
        <option value="artist">Ordenar por artista</option>
      </select>
      <button type="button" onclick="updateEnabledSongs()">Actualizar Mostrar</button>
      <button type="button" onclick="deleteSelectedSongs()">Borrar seleccionadas</button>
    </div>

    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 1em; margin-top: 1em;">
      <ul id="song-list" style="list-style: none; padding: 0;"></ul>
    </div>

    <button type="button" onclick="loadMissingArtists()">üîÑ Actualizar lista de artistas sin foto</button>

    <h2>Artistas sin foto</h2>
    <section id="no-photo"></section>

  </div>

  <h2 style="margin-top:32px;">H√≠brido (campos obtenibles por detecci√≥n)</h2>
  <div class="side-by-side">
    <div>
      <label for="hybrid-title">T√≠tulo</label>
      <input id="hybrid-title" type="text">
    </div>
    <div>
      <label for="hybrid-artist">Artista</label>
      <input id="hybrid-artist" type="text">
    </div>
    <div>
      <label for="hybrid-year">A√±o</label>
      <input id="hybrid-year" type="text">
    </div>
    <div>
      <label for="hybrid-language">Idioma</label>
      <input id="hybrid-language" type="text">
    </div>
  </div>
  <div style="margin-top:8px;">
    <button type="button" onclick="detectHybridFields()">Detectar campos</button>
  </div>

  <h2 style="margin-top:32px;">Encontrar/Arreglar un campo</h2>
  <div class="side-by-side">
    <div>
      <label for="find-id">ID</label>
      <input id="find-id" type="text">
    </div>
    <div>
      <label for="find-field">Campo</label>
      <select id="find-field">
        <option value="title">title</option>
        <option value="artist">artist</option>
        <option value="year">year</option>
        <option value="language">language</option>
        <option value="genre">genre</option>
        <option value="duration">duration</option>
        <option value="mood">mood</option>
        <option value="key">key</option>
        <option value="tempo">tempo</option>
        <option value="enabled">enabled</option>
      </select>
    </div>
  </div>
  <label for="fix2-value">Nuevo valor</label>
  <input id="fix2-value" type="text" placeholder="nuevo valor... (Y/N para enabled)">
  <button type="button" onclick="updateOneField2()">Actualizar campo</button>

  <script>
    async function submitForm() {
      try {
        const id = document.getElementById("id").value.trim();
        const data = {
          id,
          title: document.getElementById("name").value,
          artist: document.getElementById("artist").value,
          year: document.getElementById("year").value,
          language: document.getElementById("language").value,
          genre: document.getElementById("genre").value,
          duration: document.getElementById("duration").value,
          mood: document.getElementById("mood").value,
          key: document.getElementById("key").value,
          tempo: document.getElementById("tempo").value,
          lyrics: document.getElementById("lyrics").value,
          tab: document.getElementById("tab").value,
          enabled: document.getElementById("enabled").value || "Y"
        };

        if (!id) {
          alert("Debes introducir un ID.");
          return;
        }

        // Imagen y bandera (opcional)
        const imageInput = document.getElementById("image");
        const flagInput = document.getElementById("flag");
        let data2 = null;
        if (imageInput.files[0] || flagInput.files[0]) {
          data2 = {
            image: null,
            flag: null
          };

          if (imageInput.files[0]) {
            const imgForm = new FormData();
            imgForm.append("image", imageInput.files[0]);
            const imgRes = await fetch(`/upload-image/${encodeURIComponent(data.artist)}`, {
              method: "POST",
              body: imgForm
            });
            const imgMsg = await imgRes.text();
            if (!imgRes.ok) {
              alert("‚ùå " + imgMsg);
              return;
            }
            data2.image = imgMsg; // Ruta guardada
          }

          if (flagInput.files[0]) {
            const flagForm = new FormData();
            flagForm.append("flag", flagInput.files[0]);
            const flagRes = await fetch(`/upload-flag/${encodeURIComponent(data.language)}`, {
              method: "POST",
              body: flagForm
            });
            const flagMsg = await flagRes.text();
            if (!flagRes.ok) {
              alert("‚ùå " + flagMsg);
              return;
            }
            data2.flag = flagMsg; // Ruta guardada
          }
        }

        // Enviar la canci√≥n
        const res = await fetch('/add-song', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (data2) {
          await fetch(`/link-media/${encodeURIComponent(id)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data2),
          });
        }

        const msg = await res.text();
        if (!res.ok) {
          alert("‚ùå " + msg);
          return;
        }

        alert(msg);
        await refreshCatalog();   // regenerar catalog.json

        // Limpieza r√°pida
        ["id","name","artist","year","language","genre","duration","mood","key","tempo","lyrics","tab"]
          .forEach(id => document.getElementById(id).value = "");
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al a√±adir/actualizar canci√≥n");
      }
    }

    // ===== Cat√°logo (upload/refresh/download/edit) =====
    async function uploadCatalog() {
      const fileInput = document.getElementById("catalog-file");
      if (!fileInput.files || !fileInput.files[0]) {
        alert("Selecciona un CSV primero");
        return;
      }
      try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        const res = await fetch('/upload-catalog', { method: 'POST', body: formData });
        alert(await res.text());
        await refreshCatalog();
      } catch (e) {
        console.error(e);
        alert("‚ùå Error subiendo CSV");
      }
    }

    async function refreshCatalog(){
      try {
        const res = await fetch('/refresh-catalog', { method: 'POST' });
        alert(await res.text());
      } catch (e) {
        console.error(e);
        alert("‚ùå Error regenerando catalog.json");
      }
    }

    async function downloadCatalog(){
      window.location.href = '/download-catalog';
    }

    async function detectHybridFields(){
      try{
        const r = await fetch('/hybrid/detect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          title: document.getElementById('hybrid-title').value,
          artist: document.getElementById('hybrid-artist').value,
          year: document.getElementById('hybrid-year').value,
          language: document.getElementById('hybrid-language').value,
        })});
        const j = await r.json();
        alert(JSON.stringify(j, null, 2));
      }catch(e){ alert('‚ùå Error detectando'); }
    }

    async function updateOneField(){
      try{
        const res = await fetch('/update-one', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: document.getElementById('fix-id').value, field: document.getElementById('fix-field').value, value: document.getElementById('fix-value').value }) });
        alert(await res.text());
      }catch(e){ alert('‚ùå Error actualizando'); }
    }

    async function updateOneField2(){
      try{
        const res = await fetch('/update-one', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: document.getElementById('find-id').value, field: document.getElementById('find-field').value, value: document.getElementById('fix2-value').value }) });
        alert(await res.text());
      }catch(e){ alert('‚ùå Error actualizando'); }
    }

    function goBack(){ window.location.href = 'inter.html'; }

    async function loadSongList(){
      try{
        const res = await fetch('/catalog/catalog.json');
        const songs = await res.json();
        const ul = document.getElementById('song-list');
        ul.innerHTML = '';

        const header = document.createElement("li");
        header.innerHTML = `
        <span style="flex: 0 0 40px;">Borrar</span>
        <span style="flex: 0 0 60px;">Mostrar</span>
        <span style="flex: 1; font-weight: bold;">Canci√≥n</span>`;
        ul.appendChild(header);

        songs.forEach(song => {
          const li = document.createElement("li");

          const cbDelete = document.createElement("input");
          cbDelete.type = "checkbox";
          cbDelete.className = "delete-checkbox";
          cbDelete.value = song.id;

          const cbEnabled = document.createElement("input");
          cbEnabled.type = "checkbox";
          cbEnabled.className = "enabled-checkbox";
          cbEnabled.value = song.id;
          cbEnabled.checked = (song.enabled || "Y") === "Y";

          const label = document.createElement("span");
          label.textContent = `${song.title} ‚Äî ${song.artist}`;

          li.appendChild(cbDelete);
          li.appendChild(cbEnabled);
          li.appendChild(label);
          ul.appendChild(li);
        });

      }catch(e){ alert('‚ùå Error cargando lista'); }
    }

    function sortSongs(){
      try{
        const ul = document.getElementById('song-list');
        const items = Array.from(ul.querySelectorAll('li'));
        const header = items.shift();
        const by = document.getElementById('sort-songs').value;
        items.sort((a,b)=>{
          const A = a.querySelector('span').textContent.toLowerCase();
          const B = b.querySelector('span').textContent.toLowerCase();
          return A.localeCompare(B);
        });
        ul.innerHTML = '';
        ul.appendChild(header);
        items.forEach(li=> ul.appendChild(li));
      }catch(e){}
    }

    async function updateEnabledSongs(){
      try{
        const enabled = Array.from(document.querySelectorAll('.enabled-checkbox'))
          .filter(cb=> cb.checked).map(cb=> cb.value);
        const res = await fetch('/songs/enabled', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ enabled }) });
        alert(await res.text());
      }catch(e){ alert('‚ùå Error actualizando'); }
    }

    async function deleteSelectedSongs(){
      try{
        const ids = Array.from(document.querySelectorAll('.delete-checkbox'))
          .filter(cb=> cb.checked).map(cb=> cb.value);
        if (!ids.length) { alert('Selecciona alguna canci√≥n'); return; }
        if (!confirm('¬øSeguro que quieres borrarlas?')) return;
        const res = await fetch('/songs/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids }) });
        alert(await res.text());
        if (res.ok) {
          await refreshCatalog();
          await loadSongList();
        }
      } catch (e) {
        console.error(e);
        alert("‚ùå Error actualizando");
      }
    }

    async function loadMissingArtists(){
      try{
        const res = await fetch('/authors/missing');
        const data = await res.json();
        const section = document.getElementById('no-photo');
        section.innerHTML = '';
        (data.authors||[]).forEach(artist => {
          const button = document.createElement("div");
          button.textContent = artist;
          button.setAttribute("data-artist", artist);
          button.setAttribute("tabindex", "0");
          button.style.cursor = "pointer";
          button.style.border = "1px solid #aaa";
          button.style.padding = "0.5em";
          button.style.margin = "0.25em 0";
          button.style.background = "#f9f9f9";
          button.style.borderRadius = "5px";
          button.style.transition = "background 0.3s";

          button.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".jpg,.jpeg,.png,.bmp";
            input.onchange = () => uploadArtistPhoto(artist, input.files[0], button);
            input.click();
          });
          button.addEventListener("dragover", e => { e.preventDefault(); button.style.background = "#cce5cc"; });
          button.addEventListener("dragleave", () => { button.style.background = "#f9f9f9"; });
          button.addEventListener("drop", e => {
            e.preventDefault();
            button.style.background = "#f9f9f9";
            const file = e.dataTransfer.files[0];
            if (file) uploadArtistPhoto(artist, file, button);
          });
          section.appendChild(button);
        });
      } catch (e) {
        console.error(e);
        alert('‚ùå Error cargando artistas sin foto');
      }
    }

    async function uploadArtistPhoto(artist, file, buttonNode){
      try{
        const form = new FormData();
        form.append('image', file);
        const r = await fetch(`/upload-image/${encodeURIComponent(artist)}`, { method:'POST', body: form });
        const t = await r.text(); if(!r.ok) throw new Error(t);
        buttonNode.textContent = `${artist} ‚úì`;
      }catch(e){ alert('‚ùå Error subiendo imagen'); }
    }

    async function loadHybridFields(){
      try{
        const r = await fetch('/hybrid/fields');
        const j = await r.json();
        console.log('Hybrid fields available:', j); // info
      }catch(e){}
    }

    // Carga inicial
    window.addEventListener("DOMContentLoaded", () => {
      loadMissingArtists();
      loadHybridFields();
      loadSongList();
    });
  </script>

  <!-- Datalists -->
  <datalist id="artist-list"></datalist>
  <datalist id="year-list"></datalist>
  <datalist id="language-list"></datalist>
  <datalist id="genre-list"></datalist>
  <datalist id="mood-list"></datalist>
  <datalist id="key-list"></datalist>

  <!-- Script: Paste & Add (Parse + Fetch metadata + Create) -->
  <script>
  (function(){
    const $paste  = document.getElementById('paste-input');
    const $parse  = document.getElementById('btn-parse');
    const $fetch  = document.getElementById('btn-fetch');
    const $create = document.getElementById('btn-create');
    const $result = document.getElementById('parse-result');

    const f = (id)=> document.getElementById(id);

    function parsePasted(text){
      let id='', title='', artist='', year='', language='English', genre='';
      let lyrics_guess='';

      const lines = (text||'').split(/\r?\n/).map(s=>s.trim());
      const first = lines.shift()||'';

      // 1) Intentar "Artist ‚Äî Title (Year)"
      let m = first.match(/^(.*?)\s*[‚Äî-]\s*(.*?)(?:\s*\((\d{4})\))?$/);
      if(m){ artist=m[1]; title=m[2]; if(m[3]) year=m[3]; }
      else{
        // 2) Intentar "Title ‚Äî Artist (Year)"
        m = first.match(/^(.*?)\s*[‚Äî-]\s*(.*?)(?:\s*\((\d{4})\))?$/);
        if(m){ title=m[1]; artist=m[2]; if(m[3]) year=m[3]; }
      }

      // ID provisional
      id = (artist+"_"+title).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');

      lyrics_guess = lines.join('\n');

      return {id,title,artist,year,language,genre,lyrics_guess};
    }

    let lastInfo = null;

    $parse.addEventListener('click', ()=>{
      const info = parsePasted($paste.value||'');
      lastInfo = info;
      $result.style.display = 'block';
      f('det-id').value = info.id;
      f('det-title').value = info.title;
      f('det-artist').value = info.artist;
      f('det-year').value = info.year;
      f('det-lang').value = info.language;
      f('det-genre').value = info.genre;
      f('det-lyrics').value = info.lyrics_guess;
      $create.disabled = false;
    });

    $fetch.addEventListener('click', async ()=>{
      $fetch.disabled = true; $fetch.textContent = "Fetching...";
      try{
        const r = await fetch('/metadata/fetch', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          title: f('det-title').value||'', artist: f('det-artist').value||''
        })});
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'fetch_failed');
        if (j.year)  f('det-year').value  = j.year;
        if (j.genre) f('det-genre').value = j.genre;
        console.log("Metadata source:", j.source);
      } catch(e) {
        alert("No se han encontrado metadatos ahora.");
      } finally {
        $fetch.disabled = false; $fetch.textContent = "Fetch metadata";
      }
    });

$create.addEventListener('click', async ()=>{
  if (!lastInfo) {
    alert("Primero pulsa Parse.");
    return;
  }

  // 1) Tomamos los valores finales (permitiendo las ediciones manuales)
  const id       = (f('det-id').value    || lastInfo.id).trim();
  const title    = (f('det-title').value || lastInfo.title).trim();
  const artist   = (f('det-artist').value|| lastInfo.artist).trim();
  const year     = (f('det-year').value  || lastInfo.year).trim();
  const language = (f('det-lang').value  || lastInfo.language).trim();
  const genre    = (f('det-genre').value || lastInfo.genre).trim();
  const lyrics   = f('det-lyrics').value || lastInfo.lyrics_guess || "";
  const tabText  = ($paste.value || "").trim();

  if (!id || !title || !tabText) {
    alert("Faltan datos: aseg√∫rate de tener ID, Title y la Tablatura pegada.");
    return;
  }

  try{
    // 2) Creamos ficheros de TAB y Lyrics
    const r1 = await fetch('/create-files', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, title, artist, year, language, genre, lyrics, tab: tabText })});
    const j1 = await r1.json();
    if(!j1.ok) throw new Error(j1.error||'files_error');

    // 3) A√±adimos al cat√°logo
    const r2 = await fetch('/add-song', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, title, artist, year, language, genre, lyrics, enabled:'Y' })});
    const t2 = await r2.text(); if(!r2.ok) throw new Error(t2);

    alert('‚úì A√±adida y ficheros creados');
  }catch(e){ alert('‚ùå '+(e.message||e)); }
});

  })();
  </script>

  <!-- Datalists (una sola vez) -->
  <datalist id="artist-list"></datalist>
  <datalist id="year-list"></datalist>
  <datalist id="language-list"></datalist>
  <datalist id="genre-list"></datalist>
  <datalist id="mood-list"></datalist>
  <datalist id="key-list"></datalist>

  <script>
  (function(){
    // Admin overlay logic
    let isAdmin = false;
    function showLock(){ document.getElementById('admin-lock').style.display='flex'; document.getElementById('admin-pass').focus(); }
    function hideLock(){ document.getElementById('admin-lock').style.display='none'; }
    async function refreshAuth(){
      try{ const r=await fetch('/auth/status', {credentials:'same-origin'}); const j=await r.json(); isAdmin=!!j.is_admin; if(!isAdmin) showLock(); else hideLock(); }
      catch(e){ showLock(); }
    }
    async function doLogin(){
      const p=(document.getElementById('admin-pass').value||'').trim(); const msg=document.getElementById('admin-msg'); msg.textContent='';
      try{ const r=await fetch('/auth/login',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password:p}), credentials:'same-origin'});
        if(r.ok){ msg.style.color='#0a0'; msg.textContent='Unlocked'; document.getElementById('admin-pass').value=''; await refreshAuth(); }
        else{ msg.style.color='#b00020'; msg.textContent='Wrong password'; }
      }catch{ msg.style.color='#b00020'; msg.textContent='Network error'; }
    }
    document.addEventListener('DOMContentLoaded', refreshAuth);
        showLock();
        refreshAuth();
    document.getElementById('admin-login').addEventListener('click', doLogin);
    document.getElementById('admin-cancel').addEventListener('click', hideLock);
    document.getElementById('admin-pass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });
  })();
  </script>

  <script>
// Patch: 2 l√≠neas = T√≠tulo / Artista + Lyrics vac√≠as tras Parse
(function(){
  const $parse = document.getElementById('btn-parse');
  if (!$parse) return;

  function slugify(s){
    return (s||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  }
  const isSection = s => /^(intro|verse|chorus|bridge|outro|pre-?chorus|solo|coro|estrofa|puente|final)[:\s]/i.test(s);

  function fixAfterParse(){
    try{
      const paste    = document.getElementById('paste-input');
      const tEl      = document.getElementById('det-title');
      const aEl      = document.getElementById('det-artist');
      const yEl      = document.getElementById('det-year');
      const idEl     = document.getElementById('det-id');
      const lyrEl    = document.getElementById('det-lyrics');
      const createEl = document.getElementById('btn-create');

      const raw   = (paste?.value || '').replace(/\r/g,'');
      const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);

      // Caso A: 1¬™ l√≠nea = T√≠tulo, 2¬™ = Artista (si no parecen secciones tipo Intro:)
      if (lines.length >= 2 && !isSection(lines[0]) && !isSection(lines[1])) {
        if (!tEl.value) tEl.value = lines[0];
        if (!aEl.value) aEl.value = lines[1];
        const y = (lines[0].match(/\((\d{4})\)/) || lines[1].match(/\((\d{4})\)/) || [])[1];
        if (!yEl.value && y) yEl.value = y;
      } 
      // Caso B: una sola l√≠nea "Title ‚Äî Artist" o "Artist ‚Äî Title"
      else if (lines[0]) {
        const m = lines[0].match(/^(.*?)\s*[‚Äî-]\s*(.*?)(?:\s*\((\d{4})\))?$/);
        if (m && !tEl.value && !aEl.value) {
          const left=m[1].trim(), right=m[2].trim();
          const rightLooksArtist = right.split(/\s+/).length <= 5;
          if (rightLooksArtist) { tEl.value = left; aEl.value = right; }
          else { aEl.value = left; tEl.value = right; }
          if (!yEl.value && m[3]) yEl.value = m[3];
        }
      }

      // Generar ID si falta
      if (idEl && !idEl.value && tEl.value && aEl.value) {
        idEl.value = slugify(aEl.value + '_' + tEl.value);
      }

      // Lyrics vac√≠as por defecto
      if (lyrEl) lyrEl.value = '';

      // Habilitar Create si ya hay t√≠tulo e ID
      if (createEl) createEl.disabled = !(idEl?.value && tEl.value);
    }catch(e){ /* silencioso */ }
  }

  // Dejamos que tu handler original de Parse corra, y luego arreglamos
  $parse.addEventListener('click', ()=> setTimeout(fixAfterParse, 0));
})();
</script>

<script>
// Fallback de login: si POST /auth/login da 405, reintenta con GET
(function(){
  const btn = document.getElementById('admin-login');
  const input = document.getElementById('admin-pass');
  const msg = document.getElementById('admin-msg');
  const lock = document.getElementById('admin-lock');

  if (!btn || !input) return;

  // Quitamos posibles handlers anteriores para evitar doble env√≠o
  const clone = btn.cloneNode(true);
  btn.parentNode.replaceChild(clone, btn);

  async function doLoginUniversal(){
    const p = (input.value || '').trim();
    msg.textContent = '';
    try {
      // 1) Intento POST (ideal)
      let r = await fetch('/auth/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: p }),
        credentials:'same-origin'
      });

      // 2) Si el backend no permite POST ‚Üí 405 ‚Üí reintenta con GET
      if (r.status === 405) {
        r = await fetch('/auth/login?password=' + encodeURIComponent(p), {
          method:'GET',
          credentials:'same-origin'
        });
      }

      if (!r.ok) {
        msg.style.color = '#b00020';
        msg.textContent = 'Wrong password';
        return;
      }

      // OK
      msg.style.color = '#0a0';
      msg.textContent = 'Unlocked';
      input.value = '';

      // Actualiza estado y cierra overlay
      try {
        const st = await fetch('/auth/status', { credentials:'same-origin' });
        const j = await st.json();
        if (j && j.is_admin) {
          window.__isAdmin = true;
          if (lock) lock.style.display = 'none';
        }
      } catch (_) {}
    } catch (e) {
      msg.style.color = '#b00020';
      msg.textContent = 'Network error';
    }
  }

  clone.addEventListener('click', doLoginUniversal);
  input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLoginUniversal(); });
})();
</script>

<script>
(function () {
  // Si ya hay valores, no tocamos nada
  const titleEl = document.querySelector('#title');
  const artistEl = document.querySelector('#artist');
  const pasteEl = document.querySelector('#paste-area'); // ajusta si tu id difiere
  const lyricsGuessEl = document.querySelector('#lyrics_guess'); // ajusta si tu id difiere

  if (!titleEl || !artistEl || !pasteEl) return;

  // Hook tras tu parse actual (pegar despu√©s de tu parse o llamarlo en oninput)
  function fallbackTwoLineHeuristic() {
    const raw = (pasteEl.value || '').trim();
    if (!raw) return;

    // Si ya hay t√≠tulo o artista, no hacemos nada
    if ((titleEl.value || '').trim() || (artistEl.value || '').trim()) return;

    const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (lines.length >= 2) {
      // Caso cl√°sico: T√≠tulo en l√≠nea 1, Artista en l√≠nea 2
      titleEl.value = lines[0];
      artistEl.value = lines[1];

      // Si no hay m√°s texto √∫til como letra, dejamos lyrics_guess vac√≠o
      const remaining = lines.slice(2).join('\n').trim();
      if (lyricsGuessEl) {
        lyricsGuessEl.value = remaining || '';
      }
    }
  }

  // Ejecuta una vez al cargar (tras tu parse) y tambi√©n en cambios del textarea
  document.addEventListener('DOMContentLoaded', fallbackTwoLineHeuristic);
  pasteEl.addEventListener('input', fallbackTwoLineHeuristic);
})();
</script>

</body>
</html>
