<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Play That One!</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        iframe {
            display: block; /* remove inline gap */
            width: 100%;
            max-width: 100%;
        }

        #lyrics-wrapper {
            position: sticky;
            top: 0;
            background: white;
            z-index: 1000;
            border-bottom: 1px solid #ccc;
        }

        #lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0;
            padding: 6px 12px;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
        }

        #toggle-lyrics {
            cursor: pointer;
            font-size: 1.2em;
            background: none;
            border: none;
            margin-left: auto; /* Empuja el botón a la derecha */
        }

        #lyrics-container {
            padding: 20px;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            white-space: pre-line; /* ← respetar saltos de línea de la letra */
            font-size: 1.1em;
            min-height: 120px;
        }

        #ranking { margin-top: 20px; }
        #ranking li {
            cursor: pointer;
            list-style: none;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 10px;
            border: 1px solid #eee;
        }
        #ranking li .song { font-size: 1em; }
        #ranking li.selected { background-color: #fff5e6; border: 1px solid #ffcc80; }
        #ranking li.voted { background-color: #e6ffea; border: 1px solid #80ff9b; }
        #ranking .song .title { font-weight: bold; }
        #ranking .song .meta { font-size: 0.9em; color: #666; margin-left: 6px; }

        /* Agrupación */
        .group {
            margin: 16px 0;
            padding: 8px 0;
            border-top: 1px solid #eee;
        }
        .group h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0 12px 0;
            font-size: 1.15em;
        }
        .group-right {
            display: flex;
            align-items: center;
        }
        .group-right img {
            display: block;
            max-width: 120px; /* límite base; se ajusta en runtime */
            height: auto;
            border-radius: 6px;
            margin-left: 12px;
            object-fit: contain;
        }

        /* Contenedor de lista */
        .ran-container { display: grid; gap: 8px; }

        /* LET buttons */
        #lyrics-header .let-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .let-btn {
            border: 1px solid #ccc;
            background: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .let-btn.active { background: #fafafa; border-color: #999; }

        /* Footer simple */
        footer {
            margin: 24px 0 16px;
            padding-top: 12px;
            border-top: 1px solid #eee;
            color: #444;
            font-size: 0.95em;
        }
        footer a { color: #0645ad; text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* Sugerencias */
        #suggest-box {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        #suggest-box input {
            padding: 6px 10px;
            border: 1px solid #bbb;
            border-radius: 6px;
        }

        /* Responsive: tarjetas */
        .song {
            display: grid; 
            grid-template-columns: auto 1fr; 
            gap: 6px 10px; 
            align-items: center;
        }
        .song .left { grid-column: 1; }
        .song .right { grid-column: 2; }
        .song .right .title { font-weight: 600; }
        .song .right .meta  { color:#666; font-size:0.9em; }
        .song .votes { text-align: right; font-variant-numeric: tabular-nums; }

        /* Agrupación select */
        #grouping {
            margin: 10px 0;
            padding: 6px 8px;
            border: 1px solid #bbb;
            border-radius: 6px;
        }

        /* Encabezado fijo para lyrics */
        #lyrics-wrapper.hidden { display:none; }

        /* Mobile tweaks */
        @media (max-width: 600px) {
            #lyrics-header {
                font-size: 0.95em;
                padding: 6px 10px;
            }
            .group-right img { max-width: 92px; }
            #suggest-box { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="lyrics-wrapper" class="hidden">
    <div id="lyrics-header">
        <span>Now Playing</span>
        <button id="toggle-lyrics" type="button">▲</button>
        <div class="let-controls">
            <button class="let-btn" data-mode="min">LET: Min</button>
            <button class="let-btn" data-mode="half">LET: Half</button>
            <button class="let-btn" data-mode="max">LET: Max</button>
        </div>
    </div>
    <div id="lyrics-container"></div>
</div>

<div id="controls">
    <label for="grouping">Group by: </label>
    <select id="grouping">
        <option value="artist" selected>Author</option>
        <option value="language">Language</option>
        <option value="year">Year</option>
        <option value="genre">Genre</option>
    </select>

    <div id="songs-container"></div>
    <script>
        window.socket = io({ transports: ['websocket'], upgrade: false });
        const socket = window.socket;

        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = 'device_' + Math.random().toString(36).substring(2, 10);
            localStorage.setItem('deviceId', deviceId);
        }

        let catalog = [];
        let currentVotes = {};
        let selectedId = null;
        let lastVotedId = null;

        function createSongElement(song) {
            const li = document.createElement('li');
            li.id = song.id;

            const left = document.createElement('div');
            left.className = 'left votes';
            left.textContent = (currentVotes[song.id]?.length || 0);

            const right = document.createElement('div');
            right.className = 'right';
            const title = document.createElement('span');
            title.className = 'title';
            title.textContent = song.title;
            const meta = document.createElement('span');
            meta.className = 'meta';
            meta.textContent = ` — ${song.artist} · ${song.year} · ${song.language} · ${song.genre}`;

            right.append(title, meta);

            li.append(left, right);

            li.addEventListener('click', () => {
                // 1er click: selección (naranja)
                if (selectedId !== song.id) {
                    document.querySelectorAll('#ranking li').forEach(el => el.classList.remove('selected'));
                    li.classList.add('selected');
                    selectedId = song.id;
                    return;
                }
                // 2º click: confirmar voto (verde)
                vote(song.id);
                li.classList.remove('selected');
                li.classList.add('voted');
                lastVotedId = song.id;
                selectedId = null;
            });

            return li;
        }

        function refreshRanList(songs) {
            const ranContainer = document.querySelector('.ran-container');
            if (!ranContainer) return;
            ranContainer.innerHTML = "";
            songs.forEach(song => {
                const element = createSongElement(song);
                ranContainer.appendChild(element);
            });
            if (lastVotedId) {
                const votedElement = document.getElementById(lastVotedId);
                if (votedElement) votedElement.classList.add("voted");
            }
        }

        function renderGroups(grouped) {
            const container = document.getElementById('songs-container');
            container.innerHTML = '';

            Object.keys(grouped).sort((a, b) => a.localeCompare(b)).forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';

                const header = document.createElement('h3');
                header.textContent = groupName;

                const right = document.createElement('div');
                right.className = 'group-right';
                const img = document.createElement('img');

                // regla de imágenes por agrupador
                const mode = document.getElementById('grouping').value;
                if (mode === 'artist') {
                    // /songs/images/authors/<Artist>.jpg|jpeg|png|bmp
                    img.src = findImage(`/songs/images/authors/`, groupName);
                } else if (mode === 'language') {
                    img.src = findImage(`/songs/images/flags/`, groupName);
                } else if (mode === 'genre') {
                    img.src = findImage(`/songs/images/genres/`, groupName);
                } else if (mode === 'mood') {
                    img.src = findImage(`/songs/images/moods/`, groupName);
                } else {
                    img.src = '';
                }

                if (img.src) {
                    right.appendChild(img);
                }

                header.appendChild(right);
                groupDiv.appendChild(header);

                const ranContainer = document.createElement('ul');
                ranContainer.className = 'ran-container';
                groupDiv.appendChild(ranContainer);

                container.appendChild(groupDiv);

                const songs = grouped[groupName];
                refreshRanList(songs);
            });

            adjustImageHeights();
        }

        function findImage(base, name) {
            if (!name) return '';
            const candidates = [
                `${base}${name}.jpg`,
                `${base}${name}.jpeg`,
                `${base}${name}.png`,
                `${base}${name}.bmp`,
            ];
            // devolvemos el primero; si falla, el onerror lo ocultará en CSS o podemos añadir manejo
            return candidates[0];
        }

        function vote(id) {
            socket.emit('vote', {deviceId, songId: id});
            selectedId = null;
            lastVotedId = id;

            for (const songId in currentVotes) {
                if (Array.isArray(currentVotes[songId])) {
                    currentVotes[songId] = currentVotes[songId].filter(d => d !== deviceId);
                }
            }
            if (!currentVotes[id]) currentVotes[id] = [];
            currentVotes[id].push(deviceId);
            updateUI();
        }

        function updateUI() {
            // Actualiza contadores en lista
            document.querySelectorAll('#ranking li').forEach(li => {
                const id = li.id;
                const count = (currentVotes[id]?.length || 0);
                const left = li.querySelector('.left');
                if (left) left.textContent = count;
            });
        }

        async function loadCatalog() {
            const res = await fetch('/catalog/catalog.json', {cache:'no-store'});
            const cat = await res.json();
            return cat;
        }

        function groupBy(catalog, key) {
            const groups = {};
            catalog.forEach(song => {
                const val = (song[key] || 'Unknown').toString();
                if (!groups[val]) groups[val] = [];
                groups[val].push(song);
            });
            return groups;
        }

        async function fetchVotes() {
            try {
                const res = await fetch('/votes/by_device.json', {cache:'no-store'});
                const data = await res.json();
                currentVotes = {};
                // Convertimos byDevice → por canción (para contadores)
                Object.values(data || {}).forEach(entry => {
                    if (!entry?.id) return;
                    const id = entry.id;
                    if (!currentVotes[id]) currentVotes[id] = [];
                    currentVotes[id].push(entry.device);
                });
                updateUI();
            } catch (e) {}
        }

        function setupSocket() {
            socket.on('connect', () => {
                // pedir estado inicial (si tienes esa ruta/evento)
                socket.emit('update_request');
            });

            socket.on('update', payload => {
                // payload: { counts, byDevice, states }
                // Recalcular contadores desde byDevice:
                const byDevice = payload?.byDevice || {};
                currentVotes = {};
                Object.values(byDevice).forEach(entry => {
                    if (!entry?.id) return;
                    const id = entry.id;
                    if (!currentVotes[id]) currentVotes[id] = [];
                    currentVotes[id].push(entry.device);
                });
                updateUI();
            });
        }

        async function init() {
            catalog = await loadCatalog();
            const mode = document.getElementById('grouping').value;
            const grouped = groupBy(catalog, mode);
            renderGroups(grouped);

            setupSocket();
            await fetchVotes();

            document.getElementById('grouping').addEventListener('change', async () => {
                const mode = document.getElementById('grouping').value;
                const grouped = groupBy(catalog, mode);
                renderGroups(grouped);
            });

            // LET controls
            const lyricsWrapper = document.getElementById('lyrics-wrapper');
            const lyricsContainer = document.getElementById('lyrics-container');

            function setLetMode(mode) {
                // min → 0px; half → 40vh; max → 70vh (ejemplo)
                if (mode === 'min') {
                    lyricsWrapper.classList.add('hidden');
                } else {
                    lyricsWrapper.classList.remove('hidden');
                    const vh = (mode === 'half') ? 40 : 70;
                    lyricsContainer.style.maxHeight = vh + 'vh';
                    lyricsContainer.style.overflow = 'auto';
                }
                document.querySelectorAll('.let-btn').forEach(b => b.classList.remove('active'));
                const btn = document.querySelector(`.let-btn[data-mode="${mode}"]`);
                if (btn) btn.classList.add('active');
            }

            document.querySelectorAll('.let-btn').forEach(btn => {
                btn.addEventListener('click', () => setLetMode(btn.dataset.mode));
            });
            // estado inicial
            setLetMode('min');

            // Toggle ▲/▼ en header
            document.getElementById("toggle-lyrics").addEventListener("click", () => {
                const btn = document.getElementById("toggle-lyrics");
                if (lyricsWrapper.classList.contains('hidden')) {
                    setLetMode('half');
                    btn.textContent = '▼';
                } else {
                    setLetMode('min');
                    btn.textContent = '▲';
                }
            });

            // También soportar el otro handler (si lo hay)
            document.getElementById("toggle-lyrics").addEventListener("click", () => {
                const btn = document.getElementById("toggle-lyrics");
                if (lyricsWrapper.classList.contains('hidden')) {
                    setLetMode('half');
                    btn.textContent = '▼';
                } else {
                    setLetMode('min');
                    btn.textContent = '▲';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</div>

<!-- RANKING (iframe) -->
<div id="ranking">
    <iframe id="ranking-frame" src="ran.html" frameborder="0"></iframe>
</div>

<script>
    function resizeRankingFrame() {
        const iframe = document.getElementById('ranking-frame');
        if (iframe && iframe.contentWindow && iframe.contentWindow.document.body) {
            iframe.style.height = iframe.contentWindow.document.body.scrollHeight + "px";
        }
    }
    const iframe = document.getElementById('ranking-frame');
    iframe.addEventListener("load", resizeRankingFrame);
    // setInterval(resizeRankingFrame, 1000);
</script>

<!-- Sugerencias al intérprete -->
<div id="suggest-box">
    <input id="suggest-input" type="text" placeholder="Suggest a song id...">
    <button id="suggest-send" type="button">Send</button>
</div>

<footer>
    <div style="margin-top:12px;">
        <strong>PTO: El Proyecto</strong> · 
        Donaciones a PTO: 0034658327204 
        <button type="button" onclick="copyPhone()" style="padding: 4px 10px; font-size: 0.95em; cursor: pointer;">Copiar</button>
        · <a href="https://instagram.com" target="_blank" rel="noopener">Instagram</a>
    </div>
</footer>

<script>
    function copyPhone() {
        navigator.clipboard.writeText('0034658327204');
        alert('Teléfono copiado');
    }
</script>

</body>
</html>
