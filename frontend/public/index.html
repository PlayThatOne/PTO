<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Play That One!</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        iframe {
            display: block; /* remove inline gap */
            width: 100%;
            max-width: 100%;
        }

        #lyrics-wrapper {
            position: sticky;
            top: 0;
            background: white;
            z-index: 1000;
            border-bottom: 1px solid #ccc;
        }

        #lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0;
            padding: 6px 12px;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
        }

        #toggle-lyrics {
            cursor: pointer;
            font-size: 1.2em;
            background: none;
            border: none;
        }

        #lyrics-container.collapsed {
            display: none;
        }


        #ranking-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 20px;
            border-radius: 8px;
            background-color: #fdfdfd;
            max-width: 100%;
            overflow-x: auto;
        }

        #ranking-top3 {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        #ranking-top3 li {
            list-style: none;
            padding: 10px;
            flex: 1;
            margin: 0 5px;
            font-weight: bold;
            font-size: 1.1em;
            text-align: left;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #f3f3f3;
            cursor: pointer;
        }

        #ranking-rest {
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
            gap: 6px;
        }

        #ranking-rest li {
            list-style: none;
            min-width: 120px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            text-align: left;
            background-color: #f9f9f9;
            cursor: pointer;
        }

        @import url('https://fonts.googleapis.com/css2?family=Raleway:wght@500;700&display=swap');

        body {
            font-family: 'Raleway', sans-serif;
        }

        #songs-container {
            column-count: 1;
            column-gap: 20px;
            padding: 10px 20px 40px;
        }

        @media (min-width: 600px) {
            #songs-container {
                column-count: 2;
            }
        }

        @media (min-width: 1000px) {
            #songs-container {
                column-count: 3;
            }
        }

        

        .group h3 {
            margin: 0 0 4px;
            font-size: 1.15em;
            color: #333;
            border: none;
            padding: 0;
        }

        .song {
            margin: 4px 0;
            padding: 18px 28px;
            font-size: 1.2em;
            font-weight: 600;
            text-align: left;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #ccc;
            transition: background-color 0.2s ease;
            user-select: none;
            cursor: pointer;
        }

        .song:hover:not(.selected):not(.voted):not(.played) {
           #background-color: #eee;
            background-color: blue; <!--peter-->
        }


        .selected {
            background-color: orange;
        }

        .voted {
            background-color: lightgreen;
        }

        .played {
            opacity: 0.4;
            pointer-events: none;
            text-decoration: line-through;
            background-color: pink;<!--peter-->
        }

        body {
            margin: 0;
            background: url('/songs/images/fondo_horizontal.png') no-repeat center center fixed;
            background-size: cover;
        }

        @media (orientation: portrait) {
            body {
                background: url('/songs/images/fondo_vertical.png') no-repeat center center fixed;
                background-size: cover;
            }
        }

        .banner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #222;
            color: white;
        }

        .banner img {
            max-height: 50px;
        }

        .banner-title {
            font-size: 1.5em;
            text-align: left;
            flex-grow: 1;
        }

        #lyrics-container {
            padding: 20px;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            white-space: pre-wrap;
            font-size: 1.1em;
            min-height: 120px;
        }

        #ranking {
            margin-top: 20px;
        }

        #ranking li {
            cursor: pointer;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 3px 0;
            list-style: none;
        }

        #ranking li.played {
            opacity: 0.4;
            text-decoration: line-through;
            pointer-events: none;
        }

        .group h3 {
            display: flex;
            justify-content: space-between;
            align-items: center; /* centra verticalmente tanto texto como imagen */
            font-weight: bold;
        }

        .group h3 img {
            max-height: 100%; /* ocupa toda la altura disponible */
            height: auto; /* mantiene proporción */
            object-fit: contain;
            margin-left: auto;
        }



















































    
        .group {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* fuerza la alineación superior */
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 5px;
        }

        .group-left {
            flex: 1;
            padding-right: 10px;
        }

        .group-right {
            flex: 0 0 25%;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* siempre arriba */
            overflow: hidden;
        }

        .group-right img {
            max-height: calc(2.5em + 80px); /* altura epígrafe + 1 canción */
            max-width: 100%;
            height: auto;
            width: auto;
            object-fit: contain;
        }

    
#lyrics-wrapper,
#lyrics-container,
#ranking-box {
    background: none !important;
    border: none !important;
}

.song {
    background: none !important;
    border: 1px solid #ccc;
}


/* Mantener botones visibles */
.song {
    background-color: #fff !important; /* blanco por defecto */
    border: 1px solid #ccc;
}

/* Estados de botones (colores de voto) */
.song.selected {
    background-color: orange !important;
}
.song.voted {
    background-color: lightgreen !important;
}
.song.played {
    background-color: pink !important;
}

/* Fondo transparente en Live Ranking */
#ranking-box {
    background: none !important;
    border: none !important;
}

/* Botones dentro del ranking visibles */
#ranking-top3 li,
#ranking-rest li {
    background-color: #fff !important;
    border: 1px solid #ccc;
}


/* Quitar gris de Live Ranking */
#ranking-box {
    background: none !important;
    border: none !important;
}

/* Botones dentro del ranking visibles y blancos */
#ranking-top3 li,
#ranking-rest li {
    background-color: #fff !important;
    border: 1px solid #ccc;
}

/* Verde uniforme para votos */
.song.voted,
#ranking-top3 li.voted,
#ranking-rest li.voted {
    background-color: #32cd32 !important; /* verde brillante tipo RAN */
    color: #000 !important;
}


/* Forzar transparencia completa del contenedor Live Ranking */
#ranking-box,
#ranking-top3,
#ranking-rest {
    background: none !important;
    border: none !important;
}

/* Asegurar botones blancos dentro de Live Ranking */
#ranking-top3 li,
#ranking-rest li {
    background-color: #fff !important;
    border: 1px solid #ccc !important;
}

/* Verde uniforme para votos */
.song.voted,
#ranking-top3 li.voted,
#ranking-rest li.voted {
    background-color: #32cd32 !important;
    color: #000 !important;
}


/* Centrar el título en la cabecera y hacerlo más vistoso */
.banner-title {
    text-align: center !important;
    font-size: 2em !important;
    font-family: 'Lobster', cursive, 'Raleway', sans-serif !important;
    letter-spacing: 1px;
}

/* Importar la fuente Lobster para un look más atractivo */
@import url('https://fonts.googleapis.com/css2?family=Lobster&display=swap');


/* === Uniformidad VOT: mismo ancho y altura fija (30px) === */
.group-left { min-width: 0; } /* permite que el contenido no empuje al .group-right */
.song {
    width: 100%;
    max-width: 100%;
    height: 30px;              /* mitad de la altura previa de 60px */
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box;
}

/* Alinear imagen con nuevo alto del primer botón + epígrafe */
.group-right img {
    max-height: calc(2.5em + 30px) !important;
}


/* Evitar que un grupo (epígrafe + canciones) se divida entre columnas */
.group {
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    -moz-column-break-inside: avoid;
}

</style>
</head>
<body>
<div class="banner">
    <img alt="Logo" id="logo-left" src="/songs/images/logo.png"/>
    <div class="banner-title">Play That One!</div>
    <img alt="Event Logo" id="logo-right" src="/songs/images/event-logo.png"/>
</div>

<div id="lyrics-wrapper">
    <div id="lyrics-header">
        <span>Now Playing</span>
        <button id="toggle-lyrics">▲</button>
    </div>
    <div id="lyrics-container">
        Loading lyrics...
    </div>

    <iframe id="ranking-frame" src="./ran.html" style="width:100%; border:none;"></iframe>

    <!--    <object type="text/html" data="ran.html"></object>-->


<!--    <h2>Live Ranking</h2>-->
<!--    <ul id="ranking"></ul>-->

    <h1>Vote a Song</h1>
    <label for="ord-select" style="font-weight: 600; margin-left: 20px;">Order by:</label>
    <select id="ord-select" style="margin-bottom: 10px; padding: 6px; font-size: 1em;">
        <option value="artist">Artist</option>
        <option value="year">Year</option>
        <option value="language">Language</option>
        <option value="genre">Genre</option>
    </select>

    <div id="songs-container"></div>
    <script>

        // async function loadComponent(id, file) {
        //     const response = await fetch(file);
        //     const text = await response.text();
        //     document.getElementById(id).innerHTML = text;
        // }
        //
        // loadComponent("ranking", "ran.html");

//        const iframe = document.getElementById('ranking-frame');
        /* eliminado ajuste fijo */

        const socket = io();

        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = 'device_' + Math.random().toString(36).substring(2, 10);
            localStorage.setItem('deviceId', deviceId);
        }

        const CATALOG_URL = '/catalog/catalog.json';
        const songCatalog = {};
        let currentVotes = {};
        let selectedId = null;
        let nowPlayingId = null;
        let ORDER_KEY = 'artist';

        async function loadLyrics(songId) {
            if (!songId) {
                document.getElementById('lyrics-container').textContent = 'No song playing.';
                return;
            }
            try {
                const res = await fetch(`/songs/lyrics/${songId}.txt`);
                if (!res.ok) throw new Error('Lyrics not found');
                const text = await res.text();
                document.getElementById('lyrics-container').textContent = text;
            } catch (e) {
                document.getElementById('lyrics-container').textContent = 'Lyrics unavailable.';
            }
        }

        function markAll() {
            const all = document.querySelectorAll('.song');
            all.forEach(el => el.classList.remove('selected', 'voted', 'played'));

            for (const id in songCatalog) {
                const song = songCatalog[id];
                const el = document.getElementById(id);
                if (!el) continue;

                if (['played', 'now_playing'].includes(song.state)) {
                    el.classList.add('played');
                    el.onclick = null;
                    el.style.pointerEvents = 'none';
                    el.style.cursor = 'not-allowed';
                } else if (currentVotes[id]?.includes(deviceId)) el.classList.add('voted');
                else if (selectedId === id) el.classList.add('selected');
            }
        }

        
        function vote(id) {
            socket.emit('vote', {deviceId, songId: id});
            selectedId = null;

            // 🔹 Eliminar el voto anterior de este dispositivo
            for (const songId in currentVotes) {
                if (Array.isArray(currentVotes[songId])) {
                    currentVotes[songId] = currentVotes[songId].filter(d => d !== deviceId);
                }
            }

            // 🔹 Añadir el nuevo voto
            if (!currentVotes[id]) currentVotes[id] = [];
            currentVotes[id].push(deviceId);

            markAll();
        }

        let lastVotedId = null; // 🔹 guarda el último voto global

        function handleClick(id) {
            if (songCatalog[id]?.state === 'played') return;

            if (selectedId === id) {
                // Voto confirmado
                if (lastVotedId && lastVotedId !== id) {
                    updateSongState(lastVotedId, 'played'); // 🔹 la anterior se pone gris
                }

                vote(id);
                //selectedId = null;
                updateSongState(id, 'voted');   // verde
                lastVotedId = id;               // guardamos la actual como último voto
                selectedId = null;
                markAll();
            } else {
                selectedId = id;
                updateSongState(id, 'selected'); // naranja
                markAll();
            }

            // 🔹 Forzar repintado del ranking en el iframe
            const ranFrame = document.getElementById("ranking-frame");
            if (ranFrame && ranFrame.contentWindow && typeof ranFrame.contentWindow.markAll === "function") {
                console.log("[INDEX] Forzando markAll en RAN");
                ranFrame.contentWindow.markAll();
            }
        }


        async function init() {
            const res = await fetch(CATALOG_URL);
            const catalog = await res.json();
            const container = document.getElementById('songs-container');

            // Agrupar por valor del selector
            ORDER_KEY = document.getElementById('ord-select').value;
            container.innerHTML = '';
            const grouped = {};
            catalog.sort((a, b) => a.title.localeCompare(b.title));

catalog.forEach(song => {
                let group = song[ORDER_KEY];
                if (!group || group.trim() === '') group = '[Unknown]';
                if (!grouped[group]) grouped[group] = [];
                grouped[group].push(song);
                songCatalog[song.id] = song;
            });

            const keys = Object.keys(grouped).sort();
for (const artist of keys) {
                const wrapper = document.createElement('div');
                wrapper.className = 'group';
                const groupHeader = document.createElement('h3');

                if (ORDER_KEY === "year") {
                    const safeYear = parseInt(artist, 10);
                    groupHeader.textContent = safeYear;

                    const yearImg = document.createElement("img");
                    yearImg.src = `/songs/images/year/${safeYear}.png`;
                    yearImg.alt = safeYear;
                    yearImg.style.marginLeft = "10px";
                    groupHeader.appendChild(yearImg);
                } else {
                    groupHeader.textContent = artist;
                }


                const safe = encodeURIComponent(artist);
                const exts = [".jpg", ".jpeg", ".png"];
                let inserted = false;

                exts.forEach(ext => {
                    const img = document.createElement("img");
                    img.src = `/songs/images/${ORDER_KEY}/${safe}${ext}`;
                    img.alt = artist;
                    img.style.marginLeft = "10px";

                    img.onload = () => {
                        if (!inserted) {
                            inserted = true;
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'group-right';
                            imgContainer.appendChild(img);
                            wrapper.appendChild(imgContainer);
                            adjustImageHeights(); // 🔹 recalcular justo cuando se inserta
                        }
                    };

                    img.onerror = () => {
                        img.remove();
                    };
                });
                const leftContainer = document.createElement('div');
                leftContainer.className = 'group-left';
                leftContainer.appendChild(groupHeader);
                wrapper.appendChild(leftContainer);

                grouped[artist].forEach(song => {
                    const div = document.createElement('div');
                    div.id = song.id;
                    div.className = 'song';

                    const label = song.title || '[No title]';
                    div.textContent = label;

                    div.onclick = () => handleClick(song.id);
                    leftContainer.appendChild(div);
                });
                container.appendChild(wrapper);
            }
        }

        socket.on('update', (data) => {
            currentVotes = data.byDevice || {};
            const counts = data.counts || {};
            const states = data.states || {};

            let newNowPlaying = null;
            for (const id in songCatalog) {
                songCatalog[id].state = states[id] || null;
                if (songCatalog[id].state === 'now_playing') {
                    newNowPlaying = id;
                }
            }

            if (newNowPlaying !== nowPlayingId) {
                nowPlayingId = newNowPlaying;
                loadLyrics(nowPlayingId);
            }

//            const list = document.getElementById('ranking');
//            list.innerHTML = '';

//            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
//            for (const [songId, count] of sorted) {
//                const li = document.createElement('li');
//                li.textContent = `${songId}: ${count}`;
//                if (['played', 'now_playing'].includes(songCatalog[songId]?.state)) li.classList.add('played');
//                list.appendChild(li);
//            }

            markAll();
            adjustImageHeights();
        });

        document.getElementById('ord-select').addEventListener('change', () => {

            // LET toggle
            document.getElementById("toggle-lyrics").addEventListener("click", () => {
                const container = document.getElementById("lyrics-container");
                const btn = document.getElementById("toggle-lyrics");
                container.classList.toggle("collapsed");
                btn.textContent = container.classList.contains("collapsed") ? "▼" : "▲";
            });

            // RAN: render top 3 + scroll resto
            function updateRankingDisplay(rankedIds) {
                const top3 = rankedIds.slice(0, 3);
                const rest = rankedIds.slice(3);

                const top3Container = document.getElementById("ranking-top3");
                const restContainer = document.getElementById("ranking-rest");
                top3Container.innerHTML = "";
                restContainer.innerHTML = "";

                top3.forEach(id => {
                    const div = document.createElement("li");
                    div.textContent = songCatalog[id]?.title || id;
                    div.onclick = () => handleClick(id);
                    div.className = "song";
                    top3Container.appendChild(div);
                });

                rest.forEach(id => {
                    const div = document.createElement("li");
                    div.textContent = songCatalog[id]?.title || id;
                    div.onclick = () => handleClick(id);
                    div.className = "song";
                    restContainer.appendChild(div);
                });
            }


            init();
        });


        // LET toggle
        document.getElementById("toggle-lyrics").addEventListener("click", () => {
            const container = document.getElementById("lyrics-container");
            const btn = document.getElementById("toggle-lyrics");
            container.classList.toggle("collapsed");
            btn.textContent = container.classList.contains("collapsed") ? "▼" : "▲";
        });

        // RAN: render top 3 + scroll resto
        function updateRankingDisplay(rankedIds) {
            const top3 = rankedIds.slice(0, 3);
            const rest = rankedIds.slice(3);

            const top3Container = document.getElementById("ranking-top3");
            const restContainer = document.getElementById("ranking-rest");
            top3Container.innerHTML = "";
            restContainer.innerHTML = "";

            top3.forEach(id => {
                const div = document.createElement("li");
                div.textContent = songCatalog[id]?.title || id;
                div.onclick = () => handleClick(id);
                div.className = "song";
                top3Container.appendChild(div);
            });

            rest.forEach(id => {
                const div = document.createElement("li");
                div.textContent = songCatalog[id]?.title || id;
                div.onclick = () => handleClick(id);
                div.className = "song";
                restContainer.appendChild(div);
            });
        }


        init();
    </script>

        <script>
        function adjustImageHeights() {
            document.querySelectorAll('.group').forEach(group => {
                const header = group.querySelector('h3');
                const firstSong = group.querySelector('.song');
                const img = group.querySelector('.group-right img');

                if (header && firstSong && img) {
                    const limit = header.offsetHeight + firstSong.offsetHeight;
                    img.style.maxHeight = limit + "px";
                }
            });
        }

        window.addEventListener('load', adjustImageHeights);
        window.addEventListener('resize', adjustImageHeights);
        </script>


        <script>
        let lastVotedId = null;

        // Reemplazo de la función vote para actualizar lastVotedId
        function vote(id) {
            socket.emit('vote', {deviceId, songId: id});
            selectedId = null;
            lastVotedId = id;

            for (const songId in currentVotes) {
                if (Array.isArray(currentVotes[songId])) {
                    currentVotes[songId] = currentVotes[songId].filter(d => d !== deviceId);
                }
            }

            if (!currentVotes[id]) currentVotes[id] = [];
            currentVotes[id].push(deviceId);

            markAll();
        }

        // Hook para refrescar la lista de RAN manteniendo el resaltado
        function refreshRanList(songs) {
            const ranContainer = document.querySelector('.ran-container');
            ranContainer.innerHTML = "";

            songs.forEach(song => {
                const element = createSongElement(song);
                ranContainer.appendChild(element);
            });

            if (lastVotedId) {
                const votedElement = document.getElementById(lastVotedId);
                if (votedElement) votedElement.classList.add("voted");
            }
        }
        </script>


        <script>
        function resizeRankingFrame() {
            const iframe = document.getElementById('ranking-frame');
            if (iframe && iframe.contentWindow && iframe.contentWindow.document.body) {
                iframe.style.height = iframe.contentWindow.document.body.scrollHeight + "px";
            }
        }

        const iframe = document.getElementById('ranking-frame');
        iframe.addEventListener("load", resizeRankingFrame);
        setInterval(resizeRankingFrame, 1000); // ajusta dinámicamente cada segundo
        </script>

    <script src="/songStates.js"></script>


<script>
(function() {
  function fitSongLabels() {
    var nodes = document.querySelectorAll('.song');
    nodes.forEach(function(el) {
      el.style.fontSize = ''; // reset
      var computed = window.getComputedStyle(el);
      var size = parseFloat(computed.fontSize) || 19;
      var min = 9;
      // Reducir hasta que quepa en UNA sola línea dentro del ancho disponible
      while (el.scrollWidth > el.clientWidth && size > min) {
        size -= 1;
        el.style.fontSize = size + 'px';
      }
    });
  }
  window.addEventListener('load', fitSongLabels);
  window.addEventListener('resize', fitSongLabels);
  var container = document.getElementById('songs-container');
  if (container) {
    new MutationObserver(fitSongLabels).observe(container, { childList: true, subtree: true });
  }
  window.fitSongLabels = fitSongLabels;
})();
</script>

<hr style="margin-top: 40px;">

<div style="text-align: center; padding: 20px; font-size: 1.1em;">
  <a href="/pto.html" target="_blank" style="margin-right: 20px; font-weight: bold;">
    PTO: El Proyecto
  </a>

  <span style="margin-right: 10px;">
    Donaciones a PTO: <span id="pto-phone">0034658327204</span>
  </span>
  <button onclick="copyPhone()" style="padding: 4px 10px; font-size: 0.95em; cursor: pointer;">
    Copiar
  </button>

  <a href="https://www.instagram.com/playthatone" target="_blank" style="margin-left: 20px; font-weight: bold;">
    Instagram PTO
  </a>
</div>

<script>
  function copyPhone() {
    const number = document.getElementById("pto-phone").textContent;
    navigator.clipboard.writeText(number).then(() => {
      alert("Número copiado al portapapeles.");
    });
  }
</script>

</body>
</html>
