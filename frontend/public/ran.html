<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Live Ranking</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            margin: 0;
            background-color: #f8f8f8;
        }

        #ranking-box {
            border: 2px solid #999;
            padding: 16px;
            border-radius: 8px;
            background-color: white;
        }

        #ranking-box h2 {
            margin-top: 0;
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        #now-playing {
            font-weight: bold;
            margin-bottom: 12px;
        }

        #ranking-top3 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        #ranking-rest {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .rank-item {
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 10px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .rank-number {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #333;
            color: white;
            border-radius: 50%;
            font-weight: bold;
        }

        .title {
            font-weight: bold;
        }

        .votes {
            font-variant-numeric: tabular-nums;
        }

        .gold {
            background-color: #ffef99 !important;
            border-color: #e7d36f !important;
        }

        .silver {
            background-color: #e6e6e6 !important;
            border-color: #c9c9c9 !important;
        }

        .bronze {
            background-color: #ffd9b3 !important;
            border-color: #e0b58c !important;
        }

        .selected {
            background-color: orange !important;
        }

        .voted {
            background-color: limegreen !important;
        }

        .played {
            background-color: #ccc !important;
        }
    
body, #ranking-box, #ranking-top3, #ranking-rest {
    background: none !important;
}

#ranking-top3 li, #ranking-rest li {
    list-style: none;
    padding: 14px 18px;
    font-weight: normal;
    font-size: 1.1em;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #f3f3f3;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

       
.rank-number {
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #333;
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: 10px;
}
.title {
    font-weight: bold;
    display: inline-block;
}
.votes {
    font-variant-numeric: tabular-nums;
    margin-left: 12px;
}

.gold {
    background-color: #ffef99 !important;
    border-color: #e7d36f !important;
}
.silver {
    background-color: #e6e6e6 !important;
    border-color: #c9c9c9 !important;
}
.bronze {
    background-color: #ffd9b3 !important;
    border-color: #e0b58c !important;
}

.selected {
    background-color: orange !important;
}

.voted {
    background-color: limegreen !important;
}

.played {
    background-color: #ccc !important;
}
    </style>
</head>
<body>

<div id="ranking-box">
    <h2>Ranking</h2>

    <!-- Top 3 destacados -->
    <ul id="ranking-top3"></ul>

    <!-- Resto -->
    <ul id="ranking-rest"></ul>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const CATALOG_URL = "/catalog/catalog.json";
    const socket = io();  // vuelve a permitir polling/upgrade

    let songCatalog = {};
    let currentVotes = {};
    let selectedId = null;
    const deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
    localStorage.setItem("deviceId", deviceId);

//    function handleClick(id) {
//        if (selectedId === id)
//            vote(id);
//        else
//            selectedId = id;
//    }

    function vote(id) {
        selectedId = null;
        socket.emit("vote", { deviceId, songId: id });
    }

    function renderRanking(counts, states) {
        const sorted = Object.entries(counts || {}).sort((a, b) => b[1] - a[1]);

        const top3El = document.getElementById("ranking-top3");
        const restEl = document.getElementById("ranking-rest");
        top3El.innerHTML = "";
        restEl.innerHTML = "";

        sorted.forEach(([id, votes], index) => {
            const li = document.createElement("li");
            const left = document.createElement("div");
            const middle = document.createElement("div");
            const right = document.createElement("div");

            left.className = "rank-number";
            left.textContent = (index + 1);

            middle.className = "title";
            const title = (songCatalog[id]?.title || id);
            middle.textContent = title;

            right.className = "votes";
            right.textContent = votes;

            li.append(left, middle, right);

            if (states?.played?.includes(id)) li.classList.add("played");
            if (states?.now_playing === id) {
                li.classList.add("selected");
                document.getElementById("now-title").textContent = title;
            }

            if (index === 0) li.classList.add("gold");
            else if (index === 1) li.classList.add("silver");
            else if (index === 2) li.classList.add("bronze");

            if (index < 3) top3El.appendChild(li);
            else restEl.appendChild(li);
        });
    }

    // Socket updates
    socket.on("update", data => {
        currentVotes = data.counts || {};
        renderRanking(currentVotes, data.states || {});
    });

    // Initial fetch
    Promise.all([
        fetch(CATALOG_URL, { cache: "no-store" }).then(r => r.json()),
        fetch("/votes/counts.json", { cache: "no-store" }).then(r => r.json()),
        fetch("/song_states.json", { cache: "no-store" }).then(r => r.json())
    ]).then(([catalog, counts, states]) => {
        (catalog || []).forEach(s => {
            songCatalog[s.id] = { title: s.title };
        });
        currentVotes = counts.counts || {};
        renderRanking(currentVotes, states || {});
    }).catch(() => {
        // si falla, no hacemos nada para no romper la vista
    });
</script>

</body>
</html>
